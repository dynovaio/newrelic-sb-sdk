# ---------------------------------------------------------------------------- #
# Base Setup                                                                   #
# ---------------------------------------------------------------------------- #
stages:
  - test
  - bulild
  - deploy

before_script:
  - ./devops/pypi/setup_poetry.sh

cache:
  paths:
    - .cache/pypoetry

# ---------------------------------------------------------------------------- #
# Test                                                                         #
# ---------------------------------------------------------------------------- #
package:test:development:py311:
  stage: test
  image: python:3.11
  variables:
    REPORT_COVERAGE: "false"
  script:
    - ./devops/pypi/a_pycqa_1_install_dependencies.sh
    - ./devops/pypi/a_pycqa_2_execute_tests.sh
    - ./devops/pypi/a_pycqa_3_upload_coverage.sh
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - .tox
  only:
    - develop


package:test:tag:py311:
  stage: test
  image: python:3.11
  variables:
    REPORT_COVERAGE: "false"
  script:
    - ./devops/pypi/a_pycqa_1_install_dependencies.sh
    - ./devops/pypi/a_pycqa_2_execute_tests.sh
    - ./devops/pypi/a_pycqa_3_upload_coverage.sh
  only:
    - /v(\d+)\.(\d+)\.(\d+)/


package:test:master:py311:
  stage: test
  image: python:3.11
  variables:
    REPORT_COVERAGE: "true"
  script:
    - ./devops/pypi/a_pycqa_1_install_dependencies.sh
    - ./devops/pypi/a_pycqa_2_execute_tests.sh
    - ./devops/pypi/a_pycqa_3_upload_coverage.sh
  only:
    - master


# ---------------------------------------------------------------------------- #
# Package                                                                      #
# ---------------------------------------------------------------------------- #
package:bulild:tag:py311:
  stage: bulild
  image: python:3.11
  script:
    - ./devops/pypi/b_package_1_build.sh
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  dependencies:
    - package:test:tag:py311
  only:
    - /v(\d+)\.(\d+)\.(\d+)/


docs:bulild:master:py311:
  stage: bulild
  image: python:3.11
  script:
    - ./devops/pypi/b_docs_1_build.sh
  artifacts:
    paths:
      - _build/
    expire_in: 1 week
  dependencies:
    - package:test:development:py311
  only:
    - develop

# ---------------------------------------------------------------------------- #
# Release                                                                      #
# ---------------------------------------------------------------------------- #
package:deploy:tag:py311:
  stage: deploy
  image: python:3.11
  script:
    - ./devops/pypi/c_release_1_setup_credentials.sh
    - ./devops/pypi/c_release_2_publish.sh
  dependencies:
    - package:bulild:tag:py311
  only:
    - /v(\d+)\.(\d+)\.(\d+)/


docs:deploy:master:
  stage: deploy
  image: busybox:latest
  before_script:
    - echo "Doesn't need any setup"
  script:
    - ./devops/pypi/c_docs_1_publish.sh
  artifacts:
    paths:
      - public/
    expire_in: 1 week
  dependencies:
    - docs:bulild:master:py311
  only:
    - develop
